Railsアプリケーションで比較的よくある具体的な機能を実現するやり方を、taskleafアプリケーションへの機能追加という形で紹介していく

# 7-1 登録や編集の実行前に確認画面を挟む
「タスクを新規登録する際に確認画面を表示する」というものを実装していく。

今回は、新規登録画面で「確認ボタン」を押すと確認画面に遷移する。確認画面で「登録」ボタンをクリックするとタスクがデータベースに登録され、一覧画面に遷移する。
また、確認画面で「戻る」ボタンをクリックすると新規登録画面に戻ることができるようにする。
新規登録画面と確認画面の間ではお互いの画面の保持するレコードデータを相手の画面にパラメータで受け渡すことにする。この間、レコードデータはデータベースには登録されない。

## 確認画面を表示するアクションを追加する
まずは、確認画面を表示するアクションをapp/controllers/tasks_controller.rbに追加する。
ここでは、confirm_newという名前で作ることにする。

 confirm_newアクションでは、新規登録画面から受け取ったパラメータをもとにタスクオブジェクトを作成して、@task というインスタンス変数に代入する。
 新規登録画面から送られた情報の検証を行い、問題があれば新規登録画面を検証エラーメッセージと共に表示する

次にルーティングを設定する。
確認画面は「よくあるCRUDのためのアクション」とはみなされていないため、resourcesで一括で作られるルーティングとは別に定義してやる必要がある。
そこで、保存前のリソース(new)の確認をするという意味を込めて/tasks/new/confirmというURLをconfirm_newアクションに対応付けることとする。

```
resources :tasks do
    post :confirm, action: :confirm_new, on: :new
end
```

rails routesを実行すると、以下のようなルーティングが追加されたことを確認できる

```
confirm_new_task POST   /tasks/new/confirm(.:format)                                                             tasks#confirm_new
```

最後にビューを作成する。
app/views/tasks/confirm_new.html.slim を新しく作成する

管理画面では、createアクションに対して登録内容をパラメータで送るためにformを利用するが、このformはユーザーから見えない形で決まった値を贈りたいのでhidden_fieldを利用する。submitボタンを2つ置いているのは、新規画面に戻る用と登録用。

## 新規登録画面からの遷移先を変える
これまでは、新規登録画面には登録ボタンがあり、押すとcreateアクションへ遷移していた。これを、確認ボタンが合って、押すとconfirm_newアクションへ遷移するように変更する。

## 登録アクションで「戻る」ボタンからの遷移に対応する
確認画面の追加によって今までとは状況が少し変わる。

- confirm_newアクションでも検証をしているので、検証エラーがおこなる可能性は減る。しかし皆無ではないので、createアクションでも検証はしたほうが良い。検証エラーがあった場合、新規登録画面へ戻す。結果的に検証についてはコードを変更しなくて良い。
- 確認画面から「登録」が押されて遷移した場合は従来どおりの機能で良いが、「戻る」が押された場合には、戻る処理を提供する必要がある。

校舎の機能を実現するには、確認画面で「登録」「戻る」のどちらのボタンがクリックされたのかを判断する必要がある。
form要素内のsubmitボタンが押されると、パラメータに押されたボタンのname属性の値をキーとしてキャプションが格納される。
confirm_new.html.slimでは、戻るボタンには'back'という名前を与えているため、戻るボタンが押されたときは、params[:back]で"戻る"という文字列を得られる。
一方、'commit'という名前を与えている登録ボタンが押されたときは、params[:commit]で"登録"という文字列を得られる。

戻る機能を追加するために、createアクションを修正する。
「戻る」ボタンが押された場合は、現在のタスクの内容を引き継いだ状態で新規登録のフォーム画面を表示する。
それ以外の場合は、受け取ったパラメータをもとにタスクを登録して一覧画面に遷移する。


```
# 「戻る」ボタンが押された場合は、現在のタスクの内容を引き継いだ状態で新規登録のフォーム画面を表示する
if params[:back].present?
    # 新規登録フォームの画面を表示する処理はここで定義している
    render :new
    return
end
```
